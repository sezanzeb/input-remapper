name: Installation

on: [push, pull_request]

jobs:
  build:
    continue-on-error: true
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    strategy:
      matrix:
        python-version: ["3.14"]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        # broken "Error: Cache folder path is retrieved for pip but doesn't exist on disk: /home/runner/.cache/pip"
        # cache: 'pip'
        # cache-dependency-path: pyproject.toml
    - name: Install dependencies
      run: |
        # Install deps as root since we will run tests as root
        sudo scripts/ci-install-deps.sh
    - name: Try to install and import
      run: |
        set -x

        # Note, that the order of logs is kinda broken in the workflow
        sudo python3 -m install --root /

        # Make sure we aren't just importing the module from the cloned repo in the
        # cwd. The import below should import the installed package.
        cd /
        [ ! -d "inputremapper" ]

        # Helps with debugging
        find /usr/lib/python* -name inputremapper -type d
        python3 -c "import sys; print(sys.path)"
        sudo python3 -c "import sys; print(sys.path)"

        # sys.path only contains funky special paths without sudo, lets install and
        # check with sudo.
        # Should not fail with ModuleNotFoundError
        sudo python3 -c "import inputremapper"
